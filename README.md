# 不可思議の人狼 Discord Bot 仕様書

このBotは、Discordサーバー上で人狼ゲームを円滑に進行させるための多機能システムであり、主に「GM（ゲームマスター）」と「参加者（Player）」の2種類のロールを中心に構築されている。Botはスラッシュコマンドを通してゲームの募集、進行、集計を自動化し、全ての状態をファイルに永続化する設計である。

## 1. 構成概要

BotはPython製であり、ライブラリとして `discord.py` バージョン2.3.2以上を使用する。
構造はメインスクリプト `main.py` と複数の機能モジュール（Cog）によって構成される。主要なモジュールは以下の通り。

- **main.py**：Botのエントリーポイント。環境変数からDiscordトークンを読み込み、全Cogをロードしてスラッシュコマンドを同期する。Botの起動・同期・ログインを管理する。
- **config.py**：ロール名、チャンネル名、接頭辞、カテゴリ名など、ゲーム全体の命名規則を定義する。
- **storage.py**：全ての状態（参加者、日付、投票内容、HOロール、チャンネル情報など）を `game_state.json` に保存・復元するモジュール。再起動後もゲーム進行を保持できる。
- **utils.py**：GM専用のカテゴリ・チャンネルを自動生成する補助関数を含む。GM権限を持つユーザーのみが閲覧可能なカテゴリを作成し、制御チャンネル(`#gm-control`)とログチャンネル(`#gm-dashboard-log`)を配置する。
- **cogs/entry.py**：参加募集処理を行う。参加ボタンを押したユーザーにPlayerロールを付与し、取り消しボタンで削除する。募集開始と同時にGM専用カテゴリとダッシュボードを自動生成する。
- **cogs/game.py**：ゲーム開始時に実行され、Playerロールを持つユーザーにHO番号（HO1, HO2, …）を割り当て、個別のテキストチャンネル（ho-1, ho-2, …）を作成する。GMと対象プレイヤーのみが閲覧可能。
- **cogs/dashboard.py**：ゲーム進行用のGMダッシュボードを提供する。占い、狩人、霊能、人狼の結果送信UI、日付進行、投票処理を担当する。全ての操作結果は`#gm-dashboard-log`に出力される。
- **cogs/day_progress.py**：日付を手動で進めるための補助コマンド(`/bump_day`)を提供する。

## 2. 環境変数と依存関係

Botは `.env` ファイルから環境変数を読み込む。ファイルには以下の1行が必須。

```
DISCORD_TOKEN=DiscordBotのトークン
```

依存ライブラリは `requirements.txt` で定義され、以下の通り。

```
discord.py>=2.3.2
python-dotenv>=1.0.1
```

## 3. ゲームの基本的な流れ

### 3.1 エントリー（参加募集）
`/entry` コマンドで開始。実行チャンネルに募集メッセージを表示し、参加・取り消しボタンを設置。ボタン操作でPlayerロールを付与/削除し、Embedに参加者リストを更新。Botは状態をJSONに保存し、再起動後も維持。

また、同時にGM専用環境を構築する。
- カテゴリ「GM専用」自動生成。
- `#gm-control` と `#gm-dashboard-log` 作成。
- `#gm-control` にGMダッシュボード（占い・狩人・霊能・人狼UI）を配置。

### 3.2 ゲーム開始
`/start_game` コマンドで開始。Playerロールの参加者に順番で `HO1`, `HO2`, … のロールを付与し、選択カテゴリに個別チャンネル（`ho-1`など）を作成。各HOチャンネルは該当プレイヤーとGMのみ閲覧可。情報はJSONに保存され、再起動後も保持される。

### 3.3 日付進行と投票
GMは `/start_day` を使用。日付を1日進め、すべてのHOチャンネルに「誰か一人を選択してください」という投票UIを送信。投票結果はリアルタイムで `#gm-dashboard-log` に集計される。

### 3.4 役職アクション
GMダッシュボード上の占い・狩人・霊能・人狼の各UIで操作可能。
- プルダウンで対象HOを選択。
- 「結果を送信」ボタン押下でモーダルが開き、メッセージ入力。
- 送信後、指定HOチャンネルに結果投稿。
- `#gm-dashboard-log` に記録。

### 3.5 永続化
すべての状態は `storage.py` により `game_state.json` に保存され、再起動後に復元される。保存情報：参加者、投票内容、日付、ゲーム状態、メッセージID、HOチャンネル対応。

## 4. チャンネルとロール構成

- 一般：募集用チャンネル（`/entry` 実行チャンネル）
- GM専用カテゴリ：`#gm-control`, `#gm-dashboard-log`
- HOチャンネル：`ho-1`, `ho-2`, …（GM＋本人のみアクセス）
- 自動生成ロール：Player, GM, HO1〜HOn

## 5. 権限と安全性

GMロールを持つ者のみダッシュボード操作可。一般参加者は参加ボタン以外の操作不可。Botにはチャンネル管理・ロール管理権限が必要。

## 6. 技術仕様

UIは `discord.ui.View` と `discord.ui.Modal` を使用。イベントは `discord.ext.commands` と `app_commands` による。Botの状態はファイル永続化され、整合性を保持。

## 7. 拡張余地

- `/game_clear` による完全リセット。
- 自動勝敗判定や集計機能。
- 外部ログ出力（スプレッドシート連携）。
- ダッシュボードUI拡張。

## 8. 設計思想

人狼ゲームのGM作業を最小限にし、参加者体験を損なわず自動化することが目的。視覚的操作・永続化・アクセス制御・透明性を軸とし、Discordサーバー上で一連の進行を完結できる。